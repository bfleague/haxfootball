name: CI

on:
    push:
    pull_request:
    workflow_dispatch:

jobs:
    checks:
        name: Build and Lint
        runs-on: ubuntu-latest
        env:
            DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Build
              run: npm run build

            - name: Lint (Prettier check)
              run: npm run format:ci

            - name: Typecheck
              run: npx tsc --noEmit

            - name: Test
              run: npm test -- --run

            - name: Build OpenAI prompt
              if: always() && env.OPENAI_API_KEY != ''
              id: openai_prompt
              continue-on-error: true
              env:
                  EVENT_NAME: ${{ github.event_name }}
                  BEFORE_SHA: ${{ github.event.before }}
                  PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
                  PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
                  HEAD_SHA: ${{ github.sha }}
              run: |
                  if [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_BASE_SHA:-}" ] && [ -n "${PR_HEAD_SHA:-}" ]; then
                    RANGE="$PR_BASE_SHA...$PR_HEAD_SHA"
                  elif [ -n "${BEFORE_SHA:-}" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
                    RANGE="$BEFORE_SHA...$HEAD_SHA"
                  elif git rev-parse HEAD~1 >/dev/null 2>&1; then
                    RANGE="$(git rev-parse HEAD~1)...$HEAD_SHA"
                  else
                    RANGE="$HEAD_SHA"
                  fi

                  git diff --name-status "$RANGE" > /tmp/changed_files.txt || true
                  git diff --numstat "$RANGE" > /tmp/changed_files_numstat.txt || true
                  git diff --stat "$RANGE" > /tmp/changes.stat || true
                  git diff --unified=0 "$RANGE" | rg '^@@' | head -n 120 > /tmp/changes.hunks || true
                  git diff --unified=0 "$RANGE" > /tmp/changes.patch || true
                  head -c 50000 /tmp/changes.patch > /tmp/changes.trim.patch || true

                  python3 - <<'PY'
                  from pathlib import Path

                  def classify(path: str) -> str:
                      if path.startswith("src/meta/legacy/states/"):
                          return "Gameplay states"
                      if path.startswith("src/meta/legacy/shared/"):
                          return "Shared gameplay logic"
                      if path.startswith("src/meta/legacy/hooks/"):
                          return "Gameplay hooks"
                      if path.startswith("src/runtime/"):
                          return "Runtime/engine"
                      if path.startswith("src/room/"):
                          return "Room integration"
                      if path.startswith("src/common/"):
                          return "Core utilities"
                      if path.startswith("src/locales/"):
                          return "Localization"
                      if path.startswith(".github/workflows/"):
                          return "CI workflow"
                      if path.startswith("docs/"):
                          return "Documentation"
                      return "Other"

                  lines = []
                  for raw in Path("/tmp/changed_files_numstat.txt").read_text().splitlines():
                      parts = raw.split("\t", 2)
                      if len(parts) != 3:
                          continue
                      added, deleted, path = parts
                      added_label = added if added != "-" else "?"
                      deleted_label = deleted if deleted != "-" else "?"
                      lines.append(
                          f"- {path} (+{added_label}/-{deleted_label}) [{classify(path)}]"
                      )

                  Path("/tmp/changed_files_context.txt").write_text(
                      "\n".join(lines[:40])
                  )
                  PY

                  SYSTEM_PROMPT="You write CI changelog blurbs for Discord. Return 1-4 concise bullets as plain text, max 700 chars. Mention what changed from a user-facing, gameplay standpoint, not a technical one. Use the file-area context to avoid vague summaries. Do not use marketing terms or language, just clear descriptions, we are not trying to hype the changes, just summarize them.'"
                  USER_PROMPT="$(cat <<'EOF'
                  Changed files:
                  EOF
                  )"

                  USER_PROMPT="$USER_PROMPT
                  $(cat /tmp/changed_files.txt)

                  Changed files context (path, churn, area):
                  $(cat /tmp/changed_files_context.txt)

                  Diff stat:
                  $(cat /tmp/changes.stat)

                  Hunk headers:
                  $(cat /tmp/changes.hunks)

                  Patch snippet:
                  $(cat /tmp/changes.trim.patch)"

                  PARAMS="$(
                    jq -nc \
                      --arg model "gpt-4o-mini" \
                      --arg system "$SYSTEM_PROMPT" \
                      --arg user "$USER_PROMPT" \
                      '{
                        model: $model,
                        messages: [
                          { role: "system", content: $system },
                          { role: "user", content: $user }
                        ],
                        temperature: 0.2,
                        max_tokens: 220
                      }'
                  )"

                  {
                    echo "params<<EOF"
                    echo "$PARAMS"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Summarize changes with OpenAI
              if: always() && env.OPENAI_API_KEY != '' && steps.openai_prompt.outputs.params != ''
              id: openai
              continue-on-error: true
              env:
                  INPUT_MODE: chat
              uses: Just-Moh-it/openai@v0.0.1
              with:
                  openai-api-key: ${{ env.OPENAI_API_KEY }}
                  openai-mode: "chat"
                  openai-params: ${{ steps.openai_prompt.outputs.params }}

            - name: Normalize OpenAI summary
              if: always() && steps.openai.outputs.completion != ''
              id: openai_summary
              env:
                  OPENAI_COMPLETION: ${{ steps.openai.outputs.completion }}
              run: |
                  SUMMARY="$(python3 - <<'PY'
                  import os

                  text = os.environ.get("OPENAI_COMPLETION", "")
                  text = text.replace("\r\n", "\n").replace("\r", "\n").strip()
                  text = "\n".join(line.rstrip() for line in text.split("\n"))
                  print(text[:900], end="")
                  PY
                  )"

                  {
                    echo "summary<<EOF"
                    echo "$SUMMARY"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Prepare Discord metadata
              if: always() && env.DISCORD_WEBHOOK_URL != ''
              id: discord
              env:
                  JOB_STATUS: ${{ job.status }}
                  EVENT_NAME: ${{ github.event_name }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  COMMIT_MSG: ${{ github.event.head_commit.message }}
                  OPENAI_SUMMARY: ${{ steps.openai_summary.outputs.summary }}
              run: |
                  case "$JOB_STATUS" in
                    success)
                      TITLE="✅ CI Passed"
                      COLOR="5763719"
                      ;;
                    failure)
                      TITLE="❌ CI Failed"
                      COLOR="15548997"
                      ;;
                    cancelled)
                      TITLE="⚠️ CI Cancelled"
                      COLOR="16705372"
                      ;;
                    *)
                      TITLE="ℹ️ CI Finished"
                      COLOR="5793266"
                      ;;
                  esac

                  if [ -n "${OPENAI_SUMMARY:-}" ]; then
                    DETAILS="$OPENAI_SUMMARY"
                  elif [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_TITLE:-}" ]; then
                    DETAILS="PR: ${PR_TITLE}"
                  elif [ -n "${COMMIT_MSG:-}" ]; then
                    DETAILS="Commit: ${COMMIT_MSG}"
                  else
                    DETAILS="No commit summary available."
                  fi

                  DETAILS="$(printf '%s' "$DETAILS" | head -c 900)"

                  {
                    echo "title=$TITLE"
                    echo "color=$COLOR"
                    echo "details<<EOF"
                    echo "$DETAILS"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Notify Discord
              if: always() && env.DISCORD_WEBHOOK_URL != ''
              uses: tsickert/discord-webhook@v7.0.0
              with:
                  webhook-url: ${{ env.DISCORD_WEBHOOK_URL }}
                  wait: true
                  embed-title: ${{ steps.discord.outputs.title }}
                  embed-color: ${{ steps.discord.outputs.color }}
                  embed-description: |
                      **Repository:** `${{ github.repository }}`
                      **Branch:** `${{ github.ref_name }}`
                      **Status:** `${{ job.status }}`
                      **Event:** `${{ github.event_name }}`
                      **Workflow:** `${{ github.workflow }}`
                      **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                      **Commit:** [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})

                      ${{ steps.discord.outputs.details }}
                  embed-footer-text: ${{ github.repository }} • CI Bot
                  embed-author-name: Triggered by ${{ github.actor }}
                  embed-author-url: ${{ github.server_url }}/${{ github.actor }}
                  embed-author-icon-url: https://github.com/${{ github.actor }}.png
                  embed-timestamp: ${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at || github.event.repository.updated_at }}

            - name: Skip Discord notification
              if: always() && env.DISCORD_WEBHOOK_URL == ''
              run: echo "DISCORD_WEBHOOK_URL is not set; skipping notification."
