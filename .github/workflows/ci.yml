name: CI

on:
    push:
    pull_request:
    workflow_dispatch:

jobs:
    checks:
        name: Build and Lint
        runs-on: ubuntu-latest
        env:
            DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
            OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Build
              run: npm run build

            - name: Lint (Prettier check)
              run: npx prettier --check .

            - name: Typecheck
              run: npx tsc --noEmit

            - name: Test
              run: npm test -- --run

            - name: Build OpenAI prompt
              if: always() && env.OPENAI_API_KEY != ''
              id: openai_prompt
              continue-on-error: true
              env:
                  EVENT_NAME: ${{ github.event_name }}
                  BEFORE_SHA: ${{ github.event.before }}
                  PR_BASE_SHA: ${{ github.event.pull_request.base.sha }}
                  PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
                  HEAD_SHA: ${{ github.sha }}
              run: |
                  if [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_BASE_SHA:-}" ] && [ -n "${PR_HEAD_SHA:-}" ]; then
                    RANGE="$PR_BASE_SHA...$PR_HEAD_SHA"
                  elif [ -n "${BEFORE_SHA:-}" ] && [ "$BEFORE_SHA" != "0000000000000000000000000000000000000000" ]; then
                    RANGE="$BEFORE_SHA...$HEAD_SHA"
                  elif git rev-parse HEAD~1 >/dev/null 2>&1; then
                    RANGE="$(git rev-parse HEAD~1)...$HEAD_SHA"
                  else
                    RANGE="$HEAD_SHA"
                  fi

                  git diff --name-status "$RANGE" > /tmp/changed_files.txt || true
                  git diff --unified=0 "$RANGE" > /tmp/changes.patch || true
                  head -c 50000 /tmp/changes.patch > /tmp/changes.trim.patch || true

                  SYSTEM_PROMPT="You write CI changelog blurbs for Discord. Return 2-4 concise bullets as plain text, max 700 chars. Mention what changed, likely impact, and risk/test notes."
                  USER_PROMPT="$(cat <<'EOF'
                  Changed files:
                  EOF
                  )"

                  USER_PROMPT="$USER_PROMPT
                  $(cat /tmp/changed_files.txt)

                  Patch snippet:
                  $(cat /tmp/changes.trim.patch)"

                  PARAMS="$(
                    jq -nc \
                      --arg model "gpt-4o-mini" \
                      --arg system "$SYSTEM_PROMPT" \
                      --arg user "$USER_PROMPT" \
                      '{
                        model: $model,
                        messages: [
                          { role: "system", content: $system },
                          { role: "user", content: $user }
                        ],
                        temperature: 0.2,
                        max_tokens: 220
                      }'
                  )"

                  {
                    echo "params<<EOF"
                    echo "$PARAMS"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Summarize changes with OpenAI
              if: always() && env.OPENAI_API_KEY != '' && steps.openai_prompt.outputs.params != ''
              id: openai
              continue-on-error: true
              uses: Just-Moh-it/openai@v0.0.1
              with:
                  openai-api-key: ${{ env.OPENAI_API_KEY }}
                  openai-mode: chat
                  openai-params: ${{ steps.openai_prompt.outputs.params }}

            - name: Normalize OpenAI summary
              if: always() && steps.openai.outputs.completion != ''
              id: openai_summary
              run: |
                  SUMMARY="$(printf '%s' "${{ steps.openai.outputs.completion }}" | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g' | head -c 900)"
                  echo "summary=$SUMMARY" >> "$GITHUB_OUTPUT"

            - name: Prepare Discord metadata
              if: always() && env.DISCORD_WEBHOOK_URL != ''
              id: discord
              env:
                  JOB_STATUS: ${{ job.status }}
                  EVENT_NAME: ${{ github.event_name }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  COMMIT_MSG: ${{ github.event.head_commit.message }}
                  OPENAI_SUMMARY: ${{ steps.openai_summary.outputs.summary }}
              run: |
                  case "$JOB_STATUS" in
                    success)
                      TITLE="✅ CI Passed"
                      COLOR="5763719"
                      ;;
                    failure)
                      TITLE="❌ CI Failed"
                      COLOR="15548997"
                      ;;
                    cancelled)
                      TITLE="⚠️ CI Cancelled"
                      COLOR="16705372"
                      ;;
                    *)
                      TITLE="ℹ️ CI Finished"
                      COLOR="5793266"
                      ;;
                  esac

                  if [ -n "${OPENAI_SUMMARY:-}" ]; then
                    DETAILS="$OPENAI_SUMMARY"
                  elif [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_TITLE:-}" ]; then
                    DETAILS="PR: ${PR_TITLE}"
                  elif [ -n "${COMMIT_MSG:-}" ]; then
                    DETAILS="Commit: ${COMMIT_MSG}"
                  else
                    DETAILS="No commit summary available."
                  fi

                  DETAILS="$(printf '%s' "$DETAILS" | head -c 900)"

                  {
                    echo "title=$TITLE"
                    echo "color=$COLOR"
                    echo "details=$DETAILS"
                  } >> "$GITHUB_OUTPUT"

            - name: Notify Discord
              if: always() && env.DISCORD_WEBHOOK_URL != ''
              uses: tsickert/discord-webhook@v7.0.0
              with:
                  webhook-url: ${{ env.DISCORD_WEBHOOK_URL }}
                  wait: true
                  username: GitHub Actions
                  avatar-url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
                  embed-title: ${{ steps.discord.outputs.title }}
                  embed-color: ${{ steps.discord.outputs.color }}
                  embed-description: |
                      **Repository:** `${{ github.repository }}`
                      **Branch:** `${{ github.ref_name }}`
                      **Status:** `${{ job.status }}`
                      **Event:** `${{ github.event_name }}`
                      **Workflow:** `${{ github.workflow }}`
                      **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                      **Commit:** [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
                      **Actor:** `${{ github.actor }}`

                      ${{ steps.discord.outputs.details }}
                  embed-footer-text: ${{ github.repository }} • CI Bot
                  embed-author-name: Triggered by ${{ github.actor }}
                  embed-author-url: ${{ github.server_url }}/${{ github.actor }}
                  embed-author-icon-url: https://github.com/${{ github.actor }}.png
                  embed-timestamp: ${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at || github.event.repository.updated_at }}

            - name: Skip Discord notification
              if: always() && env.DISCORD_WEBHOOK_URL == ''
              run: echo "DISCORD_WEBHOOK_URL is not set; skipping notification."
