name: CI

on:
    push:
    pull_request:
    workflow_dispatch:

jobs:
    checks:
        name: Build and Lint
        runs-on: ubuntu-latest
        env:
            DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20
                  cache: npm

            - name: Install dependencies
              run: npm ci

            - name: Build
              run: npm run build

            - name: Lint (Prettier check)
              run: npx prettier --check .

            - name: Typecheck
              run: npx tsc --noEmit

            - name: Test
              run: npm test -- --run

            - name: Prepare Discord metadata
              if: always() && env.DISCORD_WEBHOOK_URL != ''
              id: discord
              env:
                  JOB_STATUS: ${{ job.status }}
                  EVENT_NAME: ${{ github.event_name }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
                  COMMIT_MSG: ${{ github.event.head_commit.message }}
              run: |
                  case "$JOB_STATUS" in
                    success)
                      TITLE="✅ CI Passed"
                      COLOR="5763719"
                      ;;
                    failure)
                      TITLE="❌ CI Failed"
                      COLOR="15548997"
                      ;;
                    cancelled)
                      TITLE="⚠️ CI Cancelled"
                      COLOR="16705372"
                      ;;
                    *)
                      TITLE="ℹ️ CI Finished"
                      COLOR="5793266"
                      ;;
                  esac

                  if [ "$EVENT_NAME" = "pull_request" ] && [ -n "${PR_TITLE:-}" ]; then
                    DETAILS="PR: ${PR_TITLE}"
                  elif [ -n "${COMMIT_MSG:-}" ]; then
                    DETAILS="Commit: ${COMMIT_MSG}"
                  else
                    DETAILS="No commit summary available."
                  fi

                  DETAILS="$(printf '%s' "$DETAILS" | head -c 900)"

                  {
                    echo "title=$TITLE"
                    echo "color=$COLOR"
                    echo "details=$DETAILS"
                  } >> "$GITHUB_OUTPUT"

            - name: Notify Discord
              if: always() && env.DISCORD_WEBHOOK_URL != ''
              uses: tsickert/discord-webhook@v7.0.0
              with:
                  webhook-url: ${{ env.DISCORD_WEBHOOK_URL }}
                  wait: true
                  username: GitHub Actions
                  avatar-url: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
                  embed-title: ${{ steps.discord.outputs.title }}
                  embed-color: ${{ steps.discord.outputs.color }}
                  embed-description: |
                      **Repository:** `${{ github.repository }}`
                      **Branch:** `${{ github.ref_name }}`
                      **Status:** `${{ job.status }}`
                      **Event:** `${{ github.event_name }}`
                      **Workflow:** `${{ github.workflow }}`
                      **Run:** [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                      **Commit:** [`${{ github.sha }}`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
                      **Actor:** `${{ github.actor }}`

                      ${{ steps.discord.outputs.details }}
                  embed-footer-text: ${{ github.repository }} • CI Bot
                  embed-author-name: Triggered by ${{ github.actor }}
                  embed-author-url: ${{ github.server_url }}/${{ github.actor }}
                  embed-author-icon-url: https://github.com/${{ github.actor }}.png
                  embed-timestamp: ${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at || github.event.repository.updated_at }}

            - name: Skip Discord notification
              if: always() && env.DISCORD_WEBHOOK_URL == ''
              run: echo "DISCORD_WEBHOOK_URL is not set; skipping notification."
